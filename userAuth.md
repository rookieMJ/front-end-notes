# 身份认证/用户鉴权

## 基本概念

### what

**身份认证**（Authentication）又称“身份验证”、“鉴权”，是指**通过一定的手段，完成对用户身份的确认**

+ 日常生活中的身份认证随处可见，例如：高铁的验票乘车，手机的密码或指纹解锁，支付宝或微信的支付密码等

+ 在 Web 开发中，也涉及到用户身份的认证，例如：各大网站的**手机验证码登录**、**邮箱密码登录**、**二维码登录**等

### why

身份认证的目的，是为了**确认当前所声称为某种身份的用户，确实是所声称的用户**例如，你去找快递员取快递，你要怎么证明这份快递是你的

在互联网项目开发中，如何对用户的身份进行认证，是一个值得深入探讨的问题例如，如何才能保证网站不会错误的将“马云的存款数额”显示到“马化腾的账户”上


### identity authentication in different mode

对于「服务端渲染」和「前后端分离」这两种开发模式来说，推荐以下不同的身份认证方案：

① 服务端渲染： **cookie + session** **认证机制**

② 前后端分离： **JWT(token)** **认证机制**


## cookie介绍

### http 无状态

了解 HTTP 协议的无状态性是进一步学习 Session 认证机制的必要前提

HTTP 协议的无状态性，指的是客户端**的每次** **HTTP** **请求都是独立的**，连续多个请求之间没有直接的关系，**服务器不会主动保留每次** **HTTP** **请求的状态**


### 如何突破http无状态的限制

对于超市来说，为了方便收银员在进行结算时给 VIP 用户打折，超市可以为每个 VIP 用户发放会员卡

注意：现实生活中的**会员卡身份认证方式**，在 Web 开发中的专业术语叫做 **Cookie**


### cookie的概念

Cookie 是**存储在用户浏览器中的一段不超过** **4 KB** **的字符串**它由一个名称（Name）、一个值（Value）和其它几个用于控制 Cookie 有效期、安全性、使用范围的可选属性组成

不同域名下的 Cookie 各自独立，每当客户端发起请求时，会**自动**把**当前域名下**所有**未过期的** **Cookie** 一同发送到服务器

### Cookie几大特性：

+ 自动发送

+ 域名独立

+ 过期时限

+ 4KB 限制


### cookie的作用

客户端第一次请求服务器的时候，服务器**通过响应头的形式**，向客户端发送一个身份认证的 Cookie，客户端会自动将 Cookie 保存在浏览器中

随后，当客户端浏览器每次请求服务器的时候，浏览器会**自动**将身份认证相关的 Cookie，**通过请求头的形式**发送给服务器，服务器即可验明客户端的身份


### cookie不具有安全性

由于 Cookie 是存储在浏览器中的，而且**浏览器也提供了读写** **Cookie** **的** **API**，因此 **Cookie** **很容易被伪造**，不具有安全性因此不建议服务器将重要的隐私数据，通过 Cookie 的形式发送给浏览器

注意：**千万不要使用** **Cookie** **存储重要且隐私的数据**！比如用户的身份信息、密码等


## session介绍

session是服务器提供开辟的内存空间，在用户登陆成功的时候，服务器会开辟空间存储数据

为了防止客户伪造会员卡，收银员在拿到客户出示的会员卡之后，可以**在收银机上进行刷卡认证**只有收银机确认存在的会员卡，才能被正常使用

这种「**会员卡** **+** **刷卡认证** 」的设计理念，就是 Session 认证机制的精髓


### Session认证的局限性

Session 认证机制需要配合 Cookie 才能实现由于 Cookie 默认不支持跨域访问，所以，当涉及到前端跨域请求后端接口的时候，**需要做很多额外的配置**，才能实现跨域 Session 认证

注意：

+ 当前端请求后端接口**不存在跨域问题**的时候，推荐使用 **Session** 身份认证机制

+ 当前端需要跨域请求后端接口的时候，推荐使用  **JWT** 认证机制

___

## token身份认证

### 地位

JWT（JSON Web Token）是目前最流行的跨域认证解决方案


### 原理

总结：用户的信息通过 tk 字符串的形式，保存在客户端浏览器中； 服务器通过还原 Token 字符串的形式来认证用户的身份

### 组成

JWT 由三部分组成：Header、Payload、Signature

后端生成、响应的完整tk中，三者间使用英文“.”进行分隔

+ payload部分**才是真正的用户信息**，它是用户信息经过base64加密之后生成的字符串

+ Header 和 Signature 与**安全性相关**，为了保证 tk 的安全性

注意：payload在前后端之间传递，仅使用base64进行简单处理，容易被拦截&解码，故不适合传递用户敏感信息


### 使用方式

- 前端

1. 客户端收到服务器返回的 JWT 之后，通常会将它储存在` localStorage` 或` sessionStorage` 中
2. 此后，客户端每次与服务器通信，都要带上这个 JWT 的字符串，从而进行身份认证推荐的做法是**把** **JWT** **放在** **HTTP** **请求头的** **`Authorization`** **字段中**，格式如下：

   ```js
   Authorization: Bearer <token>
   ```
    注意：除了被放在header，也可将 **tk** 放在请求体中与数据一同携带

- 后端
1. 登录成功, 生成token, 返回给浏览器
2. 除login外的所有接口，需判断请求是否携带了token，携带方可next()
    